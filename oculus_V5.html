<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  </head>

  <body>
	  
    <div class="svg-diagram" style="display: inline-block">
      <img src="vectors/wasd_icon.svg" alt="Diagram" />
    </div>

    <script>
      AFRAME.registerComponent("video-component", {
        schema: {
          delay: { type: "number", default: 0 },
        },
      });

      AFRAME.registerComponent("vr-oculus-controls", {
        init: function () {
          this.el.addEventListener("triggerdown", VR.togglePlay);
          this.el.addEventListener("bbuttondown", VR.reset);
        },
      });
    </script>

    <a-scene id="scene">
      <a-entity
        oculus-touch-controls="hand: right"
        vr-oculus-controls
      ></a-entity>

      <a-assets>
        <video
          id="SSRI"
          src="videos/SSRI.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video
          id="Samaritans"
          src="videos/Samaritans.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video
          id="PHQ9"
          src="videos/PHQ9.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video
          id="Sertraline"
          src="videos/Sertraline.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video
          id="Assessment"
          src="videos/Assessment.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video id="CBT" src="videos/CBT.mp4" loop="true" preload="auto"></video>
        <video id="TLP" src="videos/TLP.mp4" loop="true" preload="auto"></video>
        <video
          id="Mind"
          src="videos/Mind.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video
          id="CALM"
          src="videos/CALM.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video id="CP" src="videos/CP.mp4" loop="true" preload="auto"></video>
        <video
          id="Grounding"
          src="videos/Grounding.mp4"
          loop="true"
          preload="auto"
        ></video>
        <video
          id="Ambulance"
          src="videos/Ambulance.mp4"
          loop="true"
          preload="auto"
        ></video>
      </a-assets>

      <a-entity light="type: ambient; color: #fff"></a-entity>
      <a-entity
        light="type: directional; color: #fff; intensity: 2"
        position="0 4 0"
      ></a-entity>
		
	  <a-entity position="0 1.25 -1.25"
        text="anchor: center; width: 0.75; color: #bbb;
			  value: Press trigger to Play/Stop
Press B to restart">
      </a-entity>
		
      <a-plane
        geometry="primitive: circle; radius: 3.725; segments: 60;"
        position="0 0 0"
        rotation="-90 15 0"
        color="#000"
      ></a-plane>

      <a-plane
        video-component="delay:001000"
        sound="src:url(audio/SSRI.mp3); loop: true; rolloffFactor: 1.5; volume: 1;"
        width="2"
        height="1.125"
        position="0 1.5 -3.725"
        rotation="0 0 0"
        src="#SSRI"
      ></a-plane>

      <a-plane
        video-component="delay:033000"
        sound="src:url(audio/Samaritans.mp3); loop: true; rolloffFactor: 1.5; volume: 1.5;"
        width="2"
        height="1.125"
        position="3.225 1.5 -1.8625"
        rotation="0 -60 0"
        src="#Samaritans"
      ></a-plane>

      <a-plane
        video-component="delay:082000"
        sound="src:url(audio/Mind.mp3); loop: true; rolloffFactor: 1.5; volume: 2;"
        width="2"
        height="1.125"
        position="3.225 1.5 1.8625"
        rotation="0 -120 0"
        src="#Mind"
      ></a-plane>

      <a-plane
        video-component="delay:103000"
        sound="src:url(audio/CALM.mp3); loop: true; rolloffFactor: 1.5; volume: 2.5;"
        width="2"
        height="1.125"
        position="0 1.5 3.725"
        rotation="0 -180 0"
        src="#CALM"
      ></a-plane>

      <a-plane
        video-component="delay:120000"
        sound="src:url(audio/PHQ9.mp3); loop: true; rolloffFactor: 1.5; volume: 3;"
        width="2"
        height="1.125"
        position="-3.225 1.5 1.8625"
        rotation="0 -240 0"
        src="#PHQ9"
      ></a-plane>

      <a-plane
        video-component="delay:140000"
        sound="src:url(audio/Assessment.mp3); loop: true; rolloffFactor: 1.5; volume: 3.5;"
        width="2"
        height="1.125"
        position="-3.225 1.5 -1.8625"
        rotation="0 -300 0"
        src="#Assessment"
      ></a-plane>

      <a-plane
        video-component="delay:155000"
        sound="src:url(audio/CBT.mp3); loop: true; rolloffFactor: 1.5; volume: 4;"
        width="2"
        height="1.125"
        position="-1.8625 1.5 -3.225"
        rotation="0 30 0"
        src="#CBT"
      ></a-plane>

      <a-plane
        video-component="delay:170000"
        sound="src:url(audio/TLP.mp3); loop: true; rolloffFactor: 1.5; volume: 7;"
        width="2"
        height="1.125"
        position="1.8625 1.5 -3.225"
        rotation="0 -30 0"
        src="#TLP"
      ></a-plane>

      <a-plane
        video-component="delay:179000"
        sound="src:url(audio/CP.mp3); loop: true; rolloffFactor: 1.5; volume: 3.5;"
        width="2"
        height="1.125"
        position="3.725 1.5 0"
        rotation="0 -90 0"
        src="#CP"
      ></a-plane>

      <a-plane
        video-component="delay:185000"
        sound="src:url(audio/Sertraline.mp3); loop: true; rolloffFactor: 1.5; volume: 6;"
        width="2"
        height="1.125"
        position="1.8625 1.5 3.225"
        rotation="0 -150 0"
        src="#Sertraline"
      ></a-plane>

      <a-plane
        video-component="delay:190000"
        sound="src:url(audio/Grounding.mp3); loop: true; rolloffFactor: 1.5; volume: 7;"
        width="2"
        height="1.125"
        position="-1.8625 1.5 3.225"
        rotation="0 -210 0"
        src="#Grounding"
      ></a-plane>

      <a-plane
        video-component="delay:197000"
        sound="src:url(audio/Ambulance.mp3); loop: true; rolloffFactor: 1.5; volume: 6.5;"
        width="2"
        height="1.125"
        position="-3.725 1.5 0"
        rotation="0 -270 0"
        src="#Ambulance"
      ></a-plane>

      <a-sky color="#000"></a-sky>
    </a-scene>

    <script>
      const navLinkClickHandler = (link) => {
        const currentActiveLink = document.querySelector("#nav .active");

        if (currentActiveLink) {
          currentActiveLink.classList.remove("active");
        }

        if (link.href !== "#500") {
          VR.pause();
        }

        link.classList.add("active");
      };

      const VR = {
        isActive: false,
        isPlaying: false,
        currentTime: 0,
        scene: document.querySelector("#scene"),
      };

      VR.getPanels = () => {
        VR.panels = [];

        const panelEls = document.querySelectorAll("a-plane[video-component]");

        for (let i = 0; i < panelEls.length; i++) {
          const el = panelEls[i];

          const panel = {
            isPlaying: false,
            el: el,
            video: document.querySelector(el.getAttribute("src")),
            sound: el.components.sound,
            delay: el.getAttribute("video-component").delay,
            play: function () {
              this.isPlaying = true;

              this.video.play();
              this.sound.playSound();
            },
            pause: function () {
              this.isPlaying = false;

              this.video.pause();
              this.sound.pauseSound();
            },
            reset: function () {
              this.isPlaying = false;

              this.video.pause();
              this.video.currentTime = 0;
              this.sound.stopSound();
            },
          };

          VR.panels[i] = panel;
        }
      };

      VR.init = () => {
        VR.scene.addEventListener("loaded", () => {
          VR.getPanels();
        });

        VR.scene.onmousedown = () => {
          VR.start();

          VR.scene.onmousedown = undefined;
        };
      };

      VR.start = () => {
        VR.isActive = true;
        VR.isPlaying = true;

        const playPanels = () => {
          VR.panels.forEach((panel) => {
            if (!panel.isPlaying && panel.delay <= VR.currentTime) {
              panel.play();
            }
          });
        };

        window.setInterval(() => {
          if (VR.isPlaying) {
            playPanels();
          }

          VR.currentTime += 100;
        }, 100);
      };

      VR.play = () => {
        VR.isPlaying = true;
      };

      VR.pause = () => {
        VR.isPlaying = false;

        VR.panels.forEach((panel) => {
          panel.pause();
        });
      };

      VR.togglePlay = () => {
        if (VR.isActive && VR.isPlaying) {
          VR.pause();
        } else if (VR.isActive && !VR.isPlaying) {
          VR.play();
        }
      };

      VR.reset = () => {
        VR.isPlaying = false;
        VR.currentTime = 0;

        VR.panels.forEach((panel) => {
          panel.reset();
        });
      };

      window.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("#nav a").forEach((link) => {
          link.addEventListener("click", () => {
            navLinkClickHandler(link);
          });
        });

        const svgDiagram = document.querySelector(".svg-diagram img");

        VR.init();

        document.body.onkeyup = function (e) {
          if (e.code == "Space") {
            VR.togglePlay();
          }
        };
      });
    </script>
  </body>
</html>
